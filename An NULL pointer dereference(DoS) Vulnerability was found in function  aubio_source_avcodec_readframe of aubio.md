## Overview
An NULL pointer dereference(DoS) Vulnerability was found in function aubio_source_avcodec_readframe of aubio

## Tested Versions
aubio 0.4.6 

## Product URLs
https://aubio.org/

## Details
Aubio has an NULL pointer dereference denial-of-service vulnerability when parsing a crafted file. This occurs in the function aubio_source_avcodec_readframe of the source_avcodec.c when processing corrupted frames. 
A SEGV appears if s->avr is NULL when we call function swr_convert or avresample_convert.  

```C
void aubio_source_avcodec_readframe(aubio_source_avcodec_t *s, uint_t * read_samples) {
	......
#ifdef HAVE_AVRESAMPLE
  AVAudioResampleContext *avr = s->avr;
#elif defined(HAVE_SWRESAMPLE)
  SwrContext *avr = s->avr;
#endif /* HAVE_AVRESAMPLE || HAVE_SWRESAMPLE */
	......
#ifdef HAVE_AVRESAMPLE
  in_linesize = 0;
  av_samples_get_buffer_size(&in_linesize, avCodecCtx->channels,
      avFrame->nb_samples, avCodecCtx->sample_fmt, 1);
  in_samples = avFrame->nb_samples;
  out_linesize = 0;
  max_out_samples = AUBIO_AVCODEC_MAX_BUFFER_SIZE;
  out_samples = avresample_convert ( avr,
        (uint8_t **)&output, out_linesize, max_out_samples,
        (uint8_t **)avFrame->data, in_linesize, in_samples);
#elif defined(HAVE_SWRESAMPLE)
  in_samples = avFrame->nb_samples;
  max_out_samples = AUBIO_AVCODEC_MAX_BUFFER_SIZE / avCodecCtx->channels;
  out_samples = swr_convert( avr,
      (uint8_t **)&output, max_out_samples,
      (const uint8_t **)avFrame->data, in_samples);
#endif /* HAVE_AVRESAMPLE || HAVE_SWRESAMPLE */
  if (out_samples <= 0) {
    AUBIO_WRN("source_avcodec: no sample found while converting frame (%s)\n", s->path);
    goto beach;
  }

  *read_samples = out_samples;

beach:
  s->avFormatCtx = avFormatCtx;
  s->avCodecCtx = avCodecCtx;
  s->avFrame = avFrame;
#if defined(HAVE_AVRESAMPLE) || defined(HAVE_SWRESAMPLE)
  s->avr = avr;
#endif /* HAVE_AVRESAMPLE || HAVE_SWRESAMPLE */
  s->output = output;

  av_packet_unref(&avPacket);
}
```
when parsing a crafted file, avresample_open or swr_init failed, and then s->avr is NULL.
function aubio_source_avcodec_reset_resampler in source_avcodec.c
```
void aubio_source_avcodec_reset_resampler(aubio_source_avcodec_t * s, uint_t multi) {
  // create or reset resampler to/from mono/multi-channel
  if ( (multi != s->multi) || (s->avr == NULL) ) {
    int err;
    int64_t input_layout = av_get_default_channel_layout(s->input_channels);
    uint_t output_channels = multi ? s->input_channels : 1;
    int64_t output_layout = av_get_default_channel_layout(output_channels);
#ifdef HAVE_AVRESAMPLE
    AVAudioResampleContext *avr = avresample_alloc_context();
    AVAudioResampleContext *oldavr = s->avr;
#elif defined(HAVE_SWRESAMPLE)
    SwrContext *avr = swr_alloc();
    SwrContext *oldavr = s->avr;
#endif /* HAVE_AVRESAMPLE || HAVE_SWRESAMPLE */

    av_opt_set_int(avr, "in_channel_layout",  input_layout,           0);
    av_opt_set_int(avr, "out_channel_layout", output_layout,          0);
    av_opt_set_int(avr, "in_sample_rate",     s->input_samplerate,    0);
    av_opt_set_int(avr, "out_sample_rate",    s->samplerate,          0);
    av_opt_set_int(avr, "in_sample_fmt",      s->avCodecCtx->sample_fmt, 0);
#if HAVE_AUBIO_DOUBLE
    av_opt_set_int(avr, "out_sample_fmt",     AV_SAMPLE_FMT_DBL,      0);
#else
    av_opt_set_int(avr, "out_sample_fmt",     AV_SAMPLE_FMT_FLT,      0);
#endif
    // TODO: use planar?
    //av_opt_set_int(avr, "out_sample_fmt",     AV_SAMPLE_FMT_FLTP,      0);
#ifdef HAVE_AVRESAMPLE
    if ( ( err = avresample_open(avr) ) < 0)
#elif defined(HAVE_SWRESAMPLE)
    if ( ( err = swr_init(avr) ) < 0)
#endif /* HAVE_AVRESAMPLE || HAVE_SWRESAMPLE */
    {
      char errorstr[256];
      av_strerror (err, errorstr, sizeof(errorstr));
      AUBIO_ERR("source_avcodec: Could not open resampling context for %s (%s)\n",
          s->path, errorstr);
      return;
    }
    s->avr = avr;
    if (oldavr != NULL) {
#ifdef HAVE_AVRESAMPLE
      avresample_close( oldavr );
#elif defined(HAVE_SWRESAMPLE)
      swr_close ( oldavr );
#endif /* HAVE_AVRESAMPLE || HAVE_SWRESAMPLE */
      av_free ( oldavr );
      oldavr = NULL;
    }
    s->multi = multi;
  }
}
```

## Crash Information
exec cmd:/root/test/aubio/aubio-master/build/examples/aubiomfcc /root/test/aubio/crash-1-null-ptr
The output of gdb
```
(gdb) r /root/test/aubio/crash-1-null-ptr
Starting program: /root/test/aubio/aubio-master/build/examples/aubiomfcc /root/test/aubio/crash-1-null-ptr
[wav @ 0x605160] Estimating duration from bitrate, this may be inaccurate
[SWR @ 0x625a50] Input channel count and layout are unset
AUBIO ERROR: source_avcodec: Could not open resampling context for /root/test/aubio/crash-1-null-ptr (Invalid argument)
AUBIO WARNING: Lowest frequency bin (2048.00Hz) is higher than lowest frequency band (133.33-266.67Hz). Consider increasing the window size from 512 to 8192.
[pcm_s16le @ 0x607970] Multiple frames in a packet.

Program received signal SIGSEGV, Segmentation fault.
0x00007ffff5a851cb in swr_is_initialized (s=0x0) at libswresample/swresample.c:703
703	    return !!s->in_buffer.ch_count;
(gdb) bt
#0  0x00007ffff5a851cb in swr_is_initialized (s=0x0) at libswresample/swresample.c:703
#1  0x00007ffff5a85236 in swr_convert (s=0x0, out_arg=0x7fffffffe0a8, out_count=682, in_arg=0x608af0, in_count=85) at libswresample/swresample.c:712
#2  0x00007ffff7bc479f in aubio_source_avcodec_readframe (s=0x605060, read_samples=0x7fffffffe0fc) at ../src/io/source_avcodec.c:435
#3  0x00007ffff7bc4cd3 in aubio_source_avcodec_do (s=0x605060, read_data=0x607810, read=0x7fffffffe154) at ../src/io/source_avcodec.c:472
#4  0x0000000000402648 in examples_common_process (process_func=0x401d80 <process_block>, print=0x401d30 <process_print>) at ../examples/utils.c:168
#5  0x0000000000401c69 in main (argc=<optimized out>, argv=<optimized out>) at ../examples/aubiomfcc.c:71

```

## POC file
<a href="https://github.com/IvanCql/vulnerability/blob/master/crash-1-null-ptr">crash-1-null-ptr</a>
## CREDIT
Chen Qilian, Huawei CSPL
